$(document).ready(function() {
	// set radio buttons
	setDefaults();
	// attach event
	$("#submit-btn").on('click', addSubmission);
	$("#upload-btn").on('click', upload);

});

function setDefaults() {
	let gender = $("#gender_").val();
	if (gender) $("#gender_" + gender.toLowerCase()).prop("checked", true).trigger("click");
}

async function addSubmission() {

	$("#submit-btn").prop("disabled", true); // disable multiple submission

	// alert message
	let card = $("#resp-msg");
	card.hide();

	// input data
	let full_name = $("#full_name").val();
	let phone = $("#phone").val();
	let birth_date = $("#birth_date").val();
	let gender = $('input[name=genderRadios]:checked').val()
	let address_1 = $("#address_1").val();
	let address_2 = $("#address_2").val();
	let city = $("#city").val();
	let state = $("#state").val();
	let zip = $("#zip").val();
	let biography = $("#biography").val();
	const data = {
		full_name: full_name,
		phone: phone,
		birth_date: birth_date,
		gender: gender,
		address_1: address_1,
		address_2: address_2,
		city: city,
		state: state,
		zip: zip,
		biography: biography,
	};

	await fetch('/api/enroll', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
			},
			body: JSON.stringify(data),
		})
		.then((response) => response.json()
			.then((resp) => {
				if (response.status == 200) {
					card.text(resp.message);
					card.attr("class", "alert alert-success");
					card.show();
					return;
				}
				card.text(resp.message);
				card.attr("class", "alert alert-danger");
				card.show();
			}))
		.catch((error) => {
			card.text(error);
			card.attr("class", "alert alert-danger");
			card.show();
		});

	$("#submit-btn").prop("disabled", false);
}


async function upload() {

	$("#upload-btn").prop("disabled", true); // disable multiple submission

	// prepare alert
	let card = $("#resp-msg2");
	card.text('Please wait...');
	card.show();

	// validate
	if ($('input[type=file]')[0].files.length == 0) {
		card.text('Please select a file to upload!');
		$("#upload-btn").prop("disabled", false);
		return;
	}

	let resumeFile = $('input[type=file]')[0].files[0];
	let formData = new FormData();
	formData.append('resumeFile', resumeFile);

	await fetch('/api/upload', {
			method: 'POST',
			credentials: 'include',
			body: formData,
		})
		.then((response) => response.json()
			.then((resp) => {
				card.attr("class", "alert alert-danger");
				if (response.status == 200) {
					$('#uploaded-file-ref').attr('class','');
					$('#uploaded-file').attr('href',`/uploads/${resp.filename}`);
					$('#uploaded-file').text(resp.filename);
					card.attr("class", "alert alert-success");
				}
				resumeFile.value = []; // reset file input
				$('#file-label').text("No file selected."); // update label
				card.text(resp.message); // set response message
			}))
		.catch((error) => {
			card.attr("class", "alert alert-danger");
			card.text("This file could not be uploaded, please try again!");
		});

	$("#upload-btn").prop("disabled", false);
}

